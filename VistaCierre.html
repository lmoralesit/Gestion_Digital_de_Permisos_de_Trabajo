<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cierre PTD</title>
    <?!= include('Estilos') ?>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        .audit-badge {
            display: inline-block;
            padding: 5px 14px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 13px
        }
    </style>
</head>

<body>
    <nav class="ptd-nav">
        <div class="container"><span class="brand"><i class="bi bi-shield-check"></i> Sistema de Permisos de Trabajo
                (PTD)</span></div>
    </nav>

    <div class="container mb-5">
        <div class="ptd-card">
            <input type="hidden" id="tk" value="<?= token ?>">
            <div id="loader" class="ptd-loader">
                <div class="spinner-border"></div>
                <p>Cargando datos del permiso...</p>
            </div>
            <div id="cont" class="hidden">
                <h5 class="step-header"><i class="bi bi-door-closed-fill"></i>M√≥dulo 7: Cierre del Permiso</h5>

                <div class="info-bar mb-3">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="info-label">Permiso</div>
                            <div class="info-value" id="lblPT"></div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-label">Empresa</div>
                            <div class="info-value" id="lblEmpresa"></div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-label">√Årea</div>
                            <div class="info-value" id="lblArea"></div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-label">Inicio</div>
                            <div class="info-value small" id="lblInicio"></div>
                        </div>
                    </div>
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <div class="info-label">Descripci√≥n</div>
                            <div class="small" id="lblDesc"></div>
                        </div>
                        <div class="col-md-3">
                            <div class="info-label">Estatus</div><span class="badge" style="background:var(--emerald)"
                                id="lblEstatus"></span>
                        </div>
                    </div>
                </div>

                <div id="secAud" class="hidden mb-3">
                    <h6 class="fw-bold"><i class="bi bi-clipboard-data me-1" style="color:var(--amber)"></i>Resultado de
                        Auditor√≠as</h6>
                    <div id="listaAud"></div>
                </div>

                <hr>

                <div class="mb-4">
                    <label class="form-label fw-bold" style="color:var(--crimson)"><i
                            class="bi bi-flag me-1"></i>Estatus del Trabajo <span class="text-danger">*</span></label>
                    <select id="estCierre" class="form-select form-select-lg" title="Estatus de cierre" required>
                        <option value="">-- Seleccione --</option>
                        <option value="Culminado">‚úÖ Culminado</option>
                        <option value="Suspendido">‚è∏Ô∏è Suspendido</option>
                        <option value="Extendido">üîÑ Extendido</option>
                    </select>
                </div>

                <h6 class="fw-bold mb-3" style="color:var(--primary)"><i class="bi bi-pen me-1"></i>Firmas de Cierre
                </h6>

                <p class="small text-muted mb-2">Actor actual:</p>
                <div class="alert alert-info">
                    <strong id="lblActorActual">Cargando...</strong><br>
                    <span id="lblActorNombre" class="small"></span>
                </div>

                <div id="contenedorWidgetFirma" class="mt-3">
                    <!-- El widget din√°mico de firma -->
                    <?!= include('FirmaWidget').replace(/<%= id %>/g, 'Cerrador') ?>
                </div>

                <button class="btn btn-ptd-danger btn-lg w-100 mt-4" id="btnCerrar" onclick="cerrarEtapa()">
                    <i class="bi bi-door-closed"></i> Confirmar Firma y Continuar
                </button>
            </div>
        </div>
    </div>

    <script>
        let etapaActual = '';
        let correoEtapa = '';
        let nombreEtapa = '';

        window.onload = () => {
            google.script.run.withSuccessHandler(cargar).withFailureHandler(e => {
                document.getElementById('loader').classList.add('hidden');
                document.getElementById('cont').classList.remove('hidden');
                document.getElementById('cont').innerHTML = '<div class="alert alert-danger">Error: ' + e.message + '</div>';
            }).obtenerDatosCierre(document.getElementById('tk').value);
        };

        function cargar(r) {
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('cont').classList.remove('hidden');
            if (!r.success) { document.getElementById('cont').innerHTML = '<div class="alert alert-danger">' + r.message + '</div>'; return; }
            document.getElementById('lblPT').innerText = r.pt;
            document.getElementById('lblEmpresa').innerText = r.empresa || '-';
            document.getElementById('lblArea').innerText = r.area || '-';
            document.getElementById('lblDesc').innerText = r.desc || '-';
            document.getElementById('lblEstatus').innerText = r.estatus;
            document.getElementById('lblInicio').innerText = r.fechaInicio ? new Date(r.fechaInicio).toLocaleString('es-VE') : '-';

            // Setear actor actual basado en la etapa
            etapaActual = r.etapa; // 'Contratista', 'Solicitante', 'SSA'

            let tituloActor = '';
            if (etapaActual === 'Contratista') { tituloActor = "1. Contratista (Retiro/Limpieza)"; nombreEtapa = r.contratistaNom || "Representante Contratista"; correoEtapa = r.contratistaDoc || ""; }
            else if (etapaActual === 'Solicitante') { tituloActor = "2. Solicitante del Servicio (Recepci√≥n)"; nombreEtapa = r.solicitanteNom; correoEtapa = r.solicitanteDoc; }
            else if (etapaActual === 'SSA') { tituloActor = "3. Seguridad y Salud en el Trabajo (Cierre Administrativo)"; nombreEtapa = "Auditor/Analista SSA"; correoEtapa = r.ssaDoc; }

            document.getElementById('lblActorActual').innerText = tituloActor;
            document.getElementById('lblActorNombre').innerText = nombreEtapa + (correoEtapa ? " (" + correoEtapa + ")" : "");

            // Si no es el Contratista (quien inicia el cierre), deshabilitar/ocultar selector de estatus, porque ya lo eligi√≥ el contratista
            if (etapaActual !== 'Contratista') {
                if (r.estatusCierreActual) {
                    document.getElementById('estCierre').value = r.estatusCierreActual;
                    document.getElementById('estCierre').disabled = true;
                }
            }

            if (r.auditorias && r.auditorias.length > 0) {
                document.getElementById('secAud').classList.remove('hidden');
                let h = ''; r.auditorias.forEach((a, i) => {
                    let pct = parseFloat(a.porcentaje) || 0;
                    let cl = pct >= 80 ? 'background:var(--emerald);color:#fff' : pct >= 50 ? 'background:var(--amber);color:#fff' : 'background:var(--crimson);color:#fff';
                    h += '<div class="riesgo-card d-flex justify-content-between align-items-center py-2 mb-1"><span class="small fw-semibold">Auditor√≠a ' + (i + 1) + (a.fecha ? ' ‚Äî ' + new Date(a.fecha).toLocaleString('es-VE') : '') + '</span><span class="audit-badge" style="' + cl + '">' + pct + '%</span></div>';
                });
                document.getElementById('listaAud').innerHTML = h;
            }

            // Inicializar Widget de Firma as√≠ncronamente con robustez
            let intentos = 0;
            function intentarInit() {
                if (typeof inicializarFirmaWidget === 'function') {
                    let tipo = (etapaActual === 'Contratista') ? 'Contratista' : 'Interno';
                    inicializarFirmaWidget('Cerrador', correoEtapa, tipo);
                } else if (intentos < 10) {
                    intentos++;
                    setTimeout(intentarInit, 500);
                }
            }
            intentarInit();
        }

        function cerrarEtapa() {
            if (etapaActual === 'Contratista' && !document.getElementById('estCierre').value) {
                alert('Seleccione el estatus del trabajo.');
                return;
            }

            let resFirma = obtenerResultadoFirmaWidget('Cerrador');
            if (resFirma.error) {
                alert(resFirma.error);
                return;
            }

            let estatusCierreSelect = document.getElementById('estCierre').value || null;

            let btn = document.getElementById('btnCerrar');
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Cerrando...';
            btn.disabled = true;

            // Si solicit√≥ guardar
            if (resFirma.guardarEnBanco && correoEtapa) {
                google.script.run.guardarFirmaBanco(correoEtapa, nombreEtapa, resFirma.base64);
            }

            google.script.run.withSuccessHandler(r => {
                if (r.success) {
                    let msj = r.ptCerrado ? "Estatus: <strong>" + r.estatusElegido + "</strong><br>Fecha y hora registradas. PDF final regenerado." : "Firma registrada. Notificaci√≥n enviada al siguiente responsable.";
                    document.getElementById('cont').innerHTML = '<div class="success-screen"><div class="icon"><i class="bi bi-check-circle-fill"></i></div><h4>Etapa de Cierre Completada</h4><p class="pt-id">' + r.idPT + '</p><p class="small text-muted">' + msj + '</p></div>';
                }
                else {
                    alert('Error: ' + (r.message || ''));
                    btn.innerHTML = '<i class="bi bi-door-closed"></i> Confirmar Firma y Continuar';
                    btn.disabled = false;
                }
            }).withFailureHandler(e => {
                alert('Error: ' + e.message);
                btn.innerHTML = '<i class="bi bi-door-closed"></i> Confirmar Firma y Continuar';
                btn.disabled = false;
            }).guardarCierreSecuencial(document.getElementById('tk').value, resFirma.base64, estatusCierreSelect);
        }
    </script>
</body>

</html>