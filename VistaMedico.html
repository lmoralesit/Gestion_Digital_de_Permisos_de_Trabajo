<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Validación Médica PTD</title>
  <?!= include('Estilos') ?>
</head>

<body>
  <nav class="ptd-nav">
    <div class="container"><span class="brand"><i class="bi bi-shield-check"></i> Sistema de Permisos de Trabajo
        (PTD)</span></div>
  </nav>

  <div class="container mb-5">
    <div class="ptd-card">
      <input type="hidden" id="tk" value="<?= token ?>">
      <div id="loader" class="ptd-loader">
        <div class="spinner-border"></div>
        <p>Cargando datos médicos...</p>
      </div>
      <div id="cont" class="hidden">
        <h5 class="step-header"><i class="bi bi-heart-pulse"></i>Módulo 4: Validación Médica</h5>

        <div class="info-bar mb-4">
          <div class="row">
            <div class="col-md-4">
              <div class="info-label">Permiso</div>
              <div class="info-value" id="lblPT"></div>
            </div>
            <div class="col-md-4">
              <div class="info-label">Empresa</div>
              <div class="info-value" id="lblEmpresa"></div>
            </div>
            <div class="col-md-4">
              <div class="info-label">Tipo de Trabajo</div>
              <div class="info-value" id="lblTipo"></div>
            </div>
          </div>
        </div>

        <div id="listaTrabajadores"></div>

        <div class="mt-4 mb-3">
          <label class="form-label fw-semibold">Correo del Servicio Médico <span class="text-danger">*</span></label>
          <input type="email" id="correoMedico" class="form-control" placeholder="servicio.medico@correo.com" required>
        </div>

        <button class="btn btn-ptd-success btn-lg w-100" id="btnGuardarMedico" onclick="guardar()">
          <i class="bi bi-check-circle"></i> Guardar Evaluación Médica
        </button>
      </div>
    </div>
  </div>

  <script>
    let trabajadoresData = [];

    window.onload = () => {
      google.script.run.withSuccessHandler(cargarDatos).withFailureHandler(e => {
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('cont').classList.remove('hidden');
        document.getElementById('cont').innerHTML = '<div class="alert alert-danger">Error: ' + e.message + '</div>';
      }).obtenerDatosMedicos(document.getElementById('tk').value);
    };

    function cargarDatos(r) {
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('cont').classList.remove('hidden');
      if (!r.success) { document.getElementById('cont').innerHTML = '<div class="alert alert-danger">' + r.message + '</div>'; return; }
      document.getElementById('lblPT').innerText = r.pt;
      document.getElementById('lblEmpresa').innerText = r.empresa;
      document.getElementById('lblTipo').innerText = r.tipoTrabajo;
      trabajadoresData = r.trabajadores;
      let html = '';
      r.trabajadores.forEach((t, idx) => {
        html += `<div class="firma-section">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <span class="fw-bold" style="color:var(--primary)"><i class="bi bi-person-fill me-1"></i>${t.nombre}</span>
        <span class="badge" style="background:var(--nav-from)">C.I. ${t.cedula}</span>
      </div>
      <div class="row g-2">
        <div class="col-md-4"><label class="form-label small">Tensión Arterial <span class="text-danger">*</span></label><input type="text" class="form-control form-control-sm med-ta" id="ta${idx}" placeholder="120/80" required></div>
        <div class="col-md-4"><label class="form-label small">Frec. Cardíaca</label><input type="number" class="form-control form-control-sm med-fc" id="fc${idx}" placeholder="70"></div>
        <div class="col-md-4"><label class="form-label small">Aptitud <span class="text-danger">*</span></label><select class="form-select form-select-sm med-apt" id="apt${idx}" title="Aptitud médica"><option value="">-- --</option><option value="Apto">✅ Apto</option><option value="No Apto">❌ No Apto</option><option value="Apto con Restricción">⚠️ Apto con Restricción</option></select></div>
        <div class="col-12"><label class="form-label small">Observaciones</label><input type="text" class="form-control form-control-sm med-obs" id="obs${idx}" placeholder="Notas adicionales..."></div>
      </div>
    </div>`;
      });
      document.getElementById('listaTrabajadores').innerHTML = html;
    }

    function guardar() {
      let email = document.getElementById('correoMedico').value.trim();
      if (!email) { alert('Ingrese correo del servicio médico.'); return; }
      let evaluaciones = [];
      for (let i = 0; i < trabajadoresData.length; i++) {
        let ta = document.getElementById('ta' + i).value.trim();
        let apt = document.getElementById('apt' + i).value;
        if (!ta || !apt) { alert('Complete tensión y aptitud de todos los trabajadores.'); return; }
        evaluaciones.push({ fila: trabajadoresData[i].fila, tension: ta, fc: document.getElementById('fc' + i).value, aptitud: apt, observaciones: document.getElementById('obs' + i).value.trim(), validadoPor: email });
      }
      let btn = document.getElementById('btnGuardarMedico'); btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...'; btn.disabled = true;
      google.script.run.withSuccessHandler(r => {
        if (r.success) { document.getElementById('cont').innerHTML = '<div class="success-screen"><div class="icon"><i class="bi bi-check-circle-fill"></i></div><h4>Evaluación Médica Registrada</h4><p class="text-muted">Los datos han sido guardados. El permiso continuará al flujo de aprobación.</p></div>'; }
        else { alert('Error: ' + r.message); btn.innerHTML = '<i class="bi bi-check-circle"></i> Guardar Evaluación Médica'; btn.disabled = false; }
      }).withFailureHandler(e => { alert('Error: ' + e.message); btn.innerHTML = '<i class="bi bi-check-circle"></i> Guardar Evaluación Médica'; btn.disabled = false; }).guardarEvaluacionMedica(evaluaciones, document.getElementById('tk').value);
    }
  </script>
</body>

</html>