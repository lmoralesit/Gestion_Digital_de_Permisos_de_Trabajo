<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aprobación PTD</title>
  <?!= include('Estilos') ?>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <!-- Bootstrap JS (necesarios para los tabs del FirmaWidget) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
  <nav class="ptd-nav">
    <div class="container"><span class="brand"><i class="bi bi-shield-check"></i> Sistema de Permisos de Trabajo
        (PTD)</span></div>
  </nav>

  <div class="container mb-5">
    <div class="ptd-card">
      <input type="hidden" id="tk" value="<?= token ?>">
      <div id="loader" class="ptd-loader">
        <div class="spinner-border"></div>
        <p>Cargando permiso...</p>
      </div>
      <div id="cont" class="hidden">
        <h5 class="step-header"><i class="bi bi-clipboard-check"></i> Módulo 5: Revisión y Aprobación</h5>

        <div class="info-bar mb-3">
          <div class="row">
            <div class="col-md-3">
              <div class="info-label">Permiso</div>
              <div class="info-value" id="lblPT"></div>
            </div>
            <div class="col-md-3">
              <div class="info-label">Empresa</div>
              <div class="info-value" id="lblEmpresa"></div>
            </div>
            <div class="col-md-3">
              <div class="info-label">Localidad</div>
              <div class="info-value" id="lblLocalidad"></div>
            </div>
            <div class="col-md-3">
              <div class="info-label">Área</div>
              <div class="info-value" id="lblArea"></div>
            </div>
          </div>
        </div>
        <div id="resumenDetalle" class="mb-3"></div>
        <div id="secMedica" class="hidden mb-3"></div>

        <hr>
        <h6 class="fw-bold mb-3" style="color:var(--primary)"><i class="bi bi-pen me-1"></i>Firma de Aprobación</h6>

        <p class="small text-muted mb-2">Actor actual:</p>
        <div class="alert alert-info">
          <strong id="lblActorActual">Cargando...</strong><br>
          <span id="lblActorNombre" class="small"></span>
        </div>

        <div id="contenedorWidgetFirma" class="mt-3">
          <!-- El widget dinámico de firma -->
          <?!= include('FirmaWidget').replace(/<%= id %>/g, 'Aprobador') ?>
        </div>

        <button class="btn btn-ptd-success btn-lg w-100 mt-4" id="btnAprobar" onclick="aprobarEtapa()">
          <i class="bi bi-shield-fill-check"></i> Confirmar Firma y Continuar
        </button>
      </div>
    </div>
  </div>

  <script>
    let etapaActual = '';
    let correoEtapa = '';
    let nombreEtapa = '';

    window.onload = () => {
      google.script.run.withSuccessHandler(cargarDatos).withFailureHandler(e => {
        document.getElementById('loader').classList.add('hidden');
        document.getElementById('cont').classList.remove('hidden');
        document.getElementById('cont').innerHTML = '<div class="alert alert-danger">Error: ' + e.message + '</div>';
      }).obtenerDatosAprobacion(document.getElementById('tk').value);
    };

    function cargarDatos(r) {
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('cont').classList.remove('hidden');
      if (!r.success) { document.getElementById('cont').innerHTML = '<div class="alert alert-danger">' + r.message + '</div>'; return; }

      document.getElementById('lblPT').innerText = r.pt;
      document.getElementById('lblEmpresa').innerText = r.empresa || '';
      document.getElementById('lblLocalidad').innerText = r.localidad || '';
      document.getElementById('lblArea').innerText = r.area || '';

      // Setear actor actual basado en la etapa
      etapaActual = r.etapa; // 'Solicitante', 'Dueno', 'SSA'

      let tituloActor = '';
      if (etapaActual === 'Solicitante') { tituloActor = "1. Solicitante del Servicio"; nombreEtapa = r.solicitanteNom; correoEtapa = r.solicitanteDoc; }
      else if (etapaActual === 'Dueno') { tituloActor = "2. Dueño del Área"; nombreEtapa = r.duenoNom; correoEtapa = r.duenoDoc; }
      else if (etapaActual === 'SSA') { tituloActor = "3. Seguridad y Salud en el Trabajo (SSA)"; nombreEtapa = "Auditor/Analista SSA"; correoEtapa = r.ssaDoc; }

      document.getElementById('lblActorActual').innerText = tituloActor;
      document.getElementById('lblActorNombre').innerText = nombreEtapa + " (" + correoEtapa + ")";

      let html = '<div class="riesgo-card"><div class="row g-2">';
      html += '<div class="col-12"><div class="info-label">Descripción</div><div>' + (r.desc || '-') + '</div></div>';
      html += '<div class="col-md-4"><div class="info-label">Alto Riesgo</div><div>' + (r.altoRiesgo || '-') + '</div></div>';
      html += '<div class="col-md-4"><div class="info-label">Tipo</div><div>' + (r.tipo || 'N/A') + '</div></div>';
      html += '<div class="col-md-4"><div class="info-label">Tareas</div><div>' + (r.tareas || '-') + '</div></div>';
      html += '</div></div>';
      document.getElementById('resumenDetalle').innerHTML = html;

      // Inicializar Widget de Firma asíncronamente con robustez
      let intentos = 0;
      function intentarInit() {
        if (typeof inicializarFirmaWidget === 'function') {
          // Los aprobadores son siempre internos
          inicializarFirmaWidget('Aprobador', correoEtapa, 'Interno');
        } else if (intentos < 10) {
          intentos++;
          setTimeout(intentarInit, 500);
        }
      }
      intentarInit();
    }

    function aprobarEtapa() {
      let resFirma = obtenerResultadoFirmaWidget('Aprobador');
      if (resFirma.error) {
        alert(resFirma.error);
        return;
      }

      let btn = document.getElementById('btnAprobar');
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
      btn.disabled = true;

      // Si solicitó guardar
      if (resFirma.guardarEnBanco) {
        google.script.run.guardarFirmaBanco(correoEtapa, nombreEtapa, resFirma.base64);
      }

      google.script.run.withSuccessHandler(r => {
        if (r.success) {
          let msj = r.ptActivo ? "El permiso está ACTIVO. PDF generado y enviado por correo." : "Firma registrada. Notificación enviada al siguiente actor.";
          document.getElementById('cont').innerHTML = '<div class="success-screen"><div class="icon"><i class="bi bi-shield-fill-check"></i></div><h4>Etapa Completada</h4><p class="pt-id">' + r.idPT + '</p><p class="text-muted">' + msj + '</p></div>';
        } else {
          alert('Error: ' + r.message);
          btn.innerHTML = '<i class="bi bi-shield-fill-check"></i> Confirmar Firma y Continuar';
          btn.disabled = false;
        }
      }).withFailureHandler(e => {
        alert('Error: ' + e.message);
        btn.innerHTML = '<i class="bi bi-shield-fill-check"></i> Confirmar Firma y Continuar';
        btn.disabled = false;
      }).guardarAprobacionSecuencial(document.getElementById('tk').value, resFirma.base64);
    }
  </script>
</body>

</html>