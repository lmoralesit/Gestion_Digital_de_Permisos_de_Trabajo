<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Solicitud PTD</title>
  <?!= include('Estilos') ?>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <!-- Bootstrap JS (necesario para los modales y tabs) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>

<body>
  <nav class="ptd-nav">
    <div class="container"><span class="brand"><i class="bi bi-shield-check"></i> Sistema de Permisos de Trabajo
        (PTD)</span></div>
  </nav>

  <div class="container mb-5">
    <div class="ptd-card">
      <div id="loader" class="ptd-loader">
        <div class="spinner-border"></div>
        <p>Sincronizando sistemas...</p>
      </div>

      <form id="formPTD" class="hidden" autocomplete="off">
        <datalist id="listEmpresas"></datalist><datalist id="listBuk"></datalist>

        <!-- PROGRESS BAR -->
        <div class="progress-steps" id="progressBar">
          <div class="step-item">
            <div class="step-dot active" id="dot1">1</div>
            <div class="step-label">Ubicación</div>
          </div>
          <div class="step-item">
            <div class="step-dot" id="dot2">2</div>
            <div class="step-label">Validadores</div>
          </div>
          <div class="step-item">
            <div class="step-dot" id="dot3">3</div>
            <div class="step-label">Actividad</div>
          </div>
          <div class="step-item">
            <div class="step-dot" id="dot4">4</div>
            <div class="step-label">Riesgos</div>
          </div>
          <div class="step-item">
            <div class="step-dot" id="dot5">5</div>
            <div class="step-label">Firma</div>
          </div>
        </div>

        <div id="step1">
          <h5 class="step-header"><i class="bi bi-geo-alt-fill"></i> Módulo 1: Ubicación y Ejecutantes</h5>
          <div class="row g-3">
            <div class="col-md-6"><label class="form-label">Correo Google <span
                  class="text-danger">*</span></label><input type="email" id="correoLogin" class="form-control" required
                readonly placeholder="Cargando..."></div>
            <div class="col-md-6"><label class="form-label">Empresa Contratista <span
                  class="text-danger">*</span></label><input type="text" id="empresa" list="listEmpresas"
                class="form-control" required></div>
            <div class="col-md-4"><label class="form-label">Analista SST <span
                  class="text-danger">*</span></label><input type="text" id="nombreSST" class="form-control" required>
            </div>
            <div class="col-md-4"><label class="form-label">Cédula Analista <span
                  class="text-danger">*</span></label><input type="number" id="cedulaSST" class="form-control" required>
            </div>
            <div class="col-md-4"><label class="form-label">Área/Equipo <span class="text-danger">*</span></label><input
                type="text" id="areaEquipo" class="form-control" required></div>
            <div class="col-md-4"><label class="form-label">Unidad de Negocio <span
                  class="text-danger">*</span></label><select id="unidadNegocio" class="form-select" required></select>
            </div>
            <div class="col-md-4"><label class="form-label">Localidad <span class="text-danger">*</span></label><select
                id="localidad" class="form-select" onchange="filtroSedes()" required></select></div>
            <div class="col-md-4"><label class="form-label">Sede</label><select id="sede" class="form-select"></select>
            </div>
          </div>
          <div class="mt-4">
            <label class="form-label"><i class="bi bi-camera-fill"></i> Foto del Área <span
                class="text-danger">*</span></label>
            <input type="file" id="fotoArea" accept="image/*" capture="environment" class="form-control"
              onchange="previewFoto(this)">
            <img id="fotoPreview" class="foto-preview" alt="Vista previa">
          </div>
          <div class="mt-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label mb-0 fw-semibold"><i class="bi bi-people-fill"></i> Trabajadores Ejecutantes
                <span class="text-danger">*</span></label>
              <button type="button" class="btn btn-outline-back btn-sm" onclick="agregarTrabajador()"><i
                  class="bi bi-plus-circle"></i> Agregar</button>
            </div>
            <div class="table-responsive">
              <table class="table table-bordered tabla-din mb-0">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Cédula</th>
                    <th>Cargo</th>
                    <th class="text-center" style="width:150px">Firma (Adjuntar) *</th>
                    <th class="text-center" style="width:42px"></th>
                  </tr>
                </thead>
                <tbody id="tbodyTrab">
                </tbody>
              </table>
              <small class="text-muted mt-1 d-block"><i class="bi bi-info-circle"></i> El Analista SST se agrega
                automáticamente como ejecutor.</small>
            </div>
          </div>
          <div class="mt-4 text-end"><button type="button" class="btn btn-ptd" onclick="nav(2)">Continuar <i
                class="bi bi-arrow-right"></i></button></div>
        </div>

        <!-- STEP 2 -->
        <div id="step2" class="hidden">
          <h5 class="step-header"><i class="bi bi-building"></i> Módulo 2: Estructura Organizativa</h5>
          <div class="row g-3">
            <div class="col-12"><label class="form-label fw-semibold" style="color:var(--primary)">Solicitante Interno
                <span class="text-danger">*</span></label><input type="text" id="solic" list="listBuk"
                class="form-control" onchange="autoBuk('solic')" placeholder="Escriba nombre..."></div>
            <div class="col-md-6"><label class="form-label">Proceso (Auto)</label><input type="text"
                id="procesoSolicitante" class="form-control" readonly></div>
            <div class="col-md-6"><label class="form-label">Departamento (Auto)</label><input type="text"
                id="deptoSolicitante" class="form-control" readonly></div>
            <div class="col-12 mt-3"><label class="form-label fw-semibold" style="color:var(--emerald)">Dueño del Área
                <span class="text-danger">*</span></label><input type="text" id="dueno" list="listBuk"
                class="form-control" onchange="autoBuk('dueno')" placeholder="Escriba nombre..."></div>
            <div class="col-md-6"><label class="form-label">Proceso (Auto)</label><input type="text" id="procesoDueno"
                class="form-control" readonly></div>
            <div class="col-md-6"><label class="form-label">Departamento (Auto)</label><input type="text"
                id="deptoDueno" class="form-control" readonly></div>
          </div>
          <div class="d-flex justify-content-between mt-5"><button type="button" class="btn btn-outline-back"
              onclick="nav(1)"><i class="bi bi-arrow-left"></i> Atrás</button><button type="button" class="btn btn-ptd"
              onclick="nav(3)">Continuar <i class="bi bi-arrow-right"></i></button></div>
        </div>

        <!-- STEP 3 -->
        <div id="step3" class="hidden">
          <h5 class="step-header"><i class="bi bi-clipboard-data"></i> Módulo 3: Detalle de Actividad</h5>
          <div class="row g-3">
            <div class="col-12"><label class="form-label">Descripción del Trabajo <span
                  class="text-danger">*</span></label><textarea id="desc" class="form-control" rows="2" required
                placeholder="¿Qué se va a hacer?"></textarea></div>
            <div class="col-12"><label class="form-label">Tareas Principales <span
                  class="text-danger">*</span></label><textarea id="tareasPrincipales" class="form-control" rows="3"
                required placeholder="Paso a paso de la labor..."></textarea></div>
            <div class="col-12"><label class="form-label">Equipos/Herramientas <span
                  class="text-danger">*</span></label><textarea id="equiposHerramientas" class="form-control" rows="2"
                required placeholder="Detalle de herramientas..."></textarea></div>
            <div class="col-md-6">
              <label class="form-label fw-bold" style="color:var(--crimson)">¿Es de Alto Riesgo? <span
                  class="text-danger">*</span></label>
              <select id="altoRiesgo" class="form-select" onchange="chkAR()">
                <option value="NO">NO</option>
                <option value="SI">SI</option>
              </select>
            </div>
            <div class="col-md-6 hidden" id="divTipo">
              <label class="form-label">Tipo de Trabajo AR (múltiple)</label>
              <select id="tipoRiesgo" class="form-select" multiple size="4"
                title="Tipo de trabajo de alto riesgo"></select>
              <small class="text-muted">Ctrl+Clic para múltiple</small>
            </div>
          </div>
          <div id="zonaGases" class="zona-gases hidden mt-3">
            <h6 class="fw-bold" style="color:var(--amber)"><i class="bi bi-wind"></i> Medición de Atmósfera (Espacio
              Confinado)</h6>
            <div class="row g-2 mt-1">
              <div class="col-3"><label class="small">O₂ (%)</label><input type="text" id="gasO2"
                  class="form-control form-control-sm" placeholder="20.9"></div>
              <div class="col-3"><label class="small">LEL (%)</label><input type="text" id="gasLEL"
                  class="form-control form-control-sm" placeholder="0"></div>
              <div class="col-3"><label class="small">CO (ppm)</label><input type="text" id="gasCO"
                  class="form-control form-control-sm" placeholder="0"></div>
              <div class="col-3"><label class="small">H₂S (ppm)</label><input type="text" id="gasH2S"
                  class="form-control form-control-sm" placeholder="0"></div>
            </div>
          </div>
          <div class="d-flex justify-content-between mt-5"><button type="button" class="btn btn-outline-back"
              onclick="nav(2)"><i class="bi bi-arrow-left"></i> Atrás</button><button type="button" class="btn btn-ptd"
              onclick="nav(4)">Matriz de Riesgos <i class="bi bi-arrow-right"></i></button></div>
        </div>

        <!-- STEP 4 -->
        <div id="step4" class="hidden">
          <h5 class="step-header"><i class="bi bi-exclamation-triangle-fill"></i> Módulo 3b: Identificación de Peligros
          </h5>
          <div class="d-flex justify-content-between align-items-center mb-3">
            <p class="text-muted mb-0 small">Identifique los peligros asociados a esta actividad.</p>
            <button type="button" class="btn btn-ptd-danger btn-sm" onclick="agregarRiesgo()"><i
                class="bi bi-plus-circle"></i> Agregar Riesgo</button>
          </div>
          <div id="contenedorRiesgos"></div>
          <div class="d-flex justify-content-between mt-4"><button type="button" class="btn btn-outline-back"
              onclick="nav(3)"><i class="bi bi-arrow-left"></i> Atrás</button><button type="button" class="btn btn-ptd"
              onclick="nav(5)">Firma Final <i class="bi bi-arrow-right"></i></button></div>
        </div>

        <!-- STEP 5 -->
        <div id="step5" class="hidden">
          <h5 class="step-header"><i class="bi bi-pen-fill"></i> Firma del Analista Solicitante</h5>
          <p class="text-muted small">Firme para confirmar la veracidad de los datos. Esta firma iniciará el flujo de
            solicitudes y permisos.</p>

          <?!= include('FirmaWidget').replace(/<%= id %>/g, 'AnalistaSST') ?>

          <div class="d-flex justify-content-between mt-4">
            <button type="button" class="btn btn-outline-back" onclick="nav(4)"><i class="bi bi-arrow-left"></i>
              Atrás</button>
            <button type="button" class="btn btn-ptd-success btn-lg px-5" id="btnGuardar" onclick="guardar()"><i
                class="bi bi-send-check"></i> Solicitar Permiso PTD</button>
          </div>
        </div>

        <div id="stepResult" class="hidden"></div>
      </form>
    </div>
  </div>

  <!-- Modal Firma Trabajador -->
  <div class="modal fade" id="modalFirmaTrabajador" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-pen"></i> Firma del Trabajador</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted mb-2">Trabajador: <strong id="lblTrabNombre"></strong> (<span
              id="lblTrabCedula"></span>)</p>
          <div id="contenedorWidgetModal">
            <!-- El widget se insertará aquí dinámicamente o usaremos el mismo con un ID genérico -->
            <?!= include('FirmaWidget').replace(/<%= id %>/g, 'TrabajadorModal') ?>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="confirmarFirmaModal()">Confirmar Firma</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let conf = {}, buk = [];
    let contadorRiesgos = 0;
    const TOTAL_STEPS = 5;

    window.onload = () => {
      google.script.run
        .withSuccessHandler(res => {
          document.getElementById('correoLogin').value = res.email || '';

          // Re-intentar inicialización si el script no ha cargado
          let intentos = 0;
          function intentarInit() {
            if (typeof inicializarFirmaWidget === 'function') {
              inicializarFirmaWidget('AnalistaSST', res.email, res.auth.tipo);
            } else if (intentos < 10) {
              intentos++;
              setTimeout(intentarInit, 500);
            }
          }
          intentarInit();
        })
        .getCorreoActual();

      google.script.run.withSuccessHandler(r => { conf = r; inicializarListas(); }).withFailureHandler(e => alert('Error: ' + e.message)).obtenerListasConfig();
      google.script.run.withSuccessHandler(r => {
        buk = r;
        document.getElementById('listBuk').innerHTML = r.map(b => `<option value="${b.nombre}">`).join('');
      }).obtenerColaboradoresBuk();

      // Iniciar sync analista
      setInterval(syncAnalista, 1000);
    };

    function syncAnalista() {
      let nom = document.getElementById('nombreSST').value.trim();
      let ced = document.getElementById('cedulaSST').value.trim();
      let tbody = document.getElementById('tbodyTrab');
      let rowAnalista = Array.from(tbody.rows).find(r => r.dataset.analista === "true");

      if (nom && ced) {
        if (!rowAnalista) {
          let tr = document.createElement('tr');
          tr.dataset.analista = "true";
          tr.innerHTML = `
            <td><input type="text" class="form-control form-control-sm t-nombre" value="${nom}" readonly></td>
            <td><input type="text" class="form-control form-control-sm t-cedula" value="${ced}" readonly></td>
            <td><input type="text" class="form-control form-control-sm t-cargo" value="Analista SST" readonly></td>
            <td><input type="file" class="form-control form-control-sm t-firma-file" accept="image/png, image/jpeg" required></td>
            <td class="text-center"></td>
          `;
          tbody.prepend(tr);
        } else {
          rowAnalista.querySelector('.t-nombre').value = nom;
          rowAnalista.querySelector('.t-cedula').value = ced;
        }
      } else if (rowAnalista) {
        rowAnalista.remove();
      }
    }

    function inicializarListas() {
      document.getElementById('listEmpresas').innerHTML = conf.empresas.map(e => '<option value="' + e + '">').join('');
      document.getElementById('unidadNegocio').innerHTML = '<option value="">-- Seleccione --</option>' + conf.unidades.map(u => '<option>' + u + '</option>').join('');
      document.getElementById('localidad').innerHTML = '<option value="">-- Seleccione --</option>' + conf.localidades.map(l => '<option>' + l + '</option>').join('');
      document.getElementById('tipoRiesgo').innerHTML = conf.tiposTrabajo.map(t => '<option value="' + t + '">' + t + '</option>').join('');
      document.getElementById('loader').classList.add('hidden');
      document.getElementById('formPTD').classList.remove('hidden');
      agregarRiesgo();
    }
    function inicializarBuk() { document.getElementById('listBuk').innerHTML = buk.map(b => '<option value="' + b.nombre + '">').join(''); }
    function filtroSedes() { let l = document.getElementById('localidad').value; let s = document.getElementById('sede'); s.innerHTML = '<option value="">-- Sin sede --</option>'; conf.sedesMap.forEach(m => { let p = m.split('|'); if (p[0] === l) s.innerHTML += '<option>' + p[1] + '</option>'; }); }

    function nav(s) {
      let cur = document.querySelector('[id^="step"]:not(.hidden)');
      if (cur) { let cn = parseInt(cur.id.replace('step', '')); if (s > cn && !validarStep(cn)) return; }
      for (let i = 1; i <= TOTAL_STEPS; i++) { document.getElementById('step' + i).classList.add('hidden'); let d = document.getElementById('dot' + i); d.classList.remove('active'); if (i < s) d.classList.add('done'); else d.classList.remove('done'); }
      document.getElementById('step' + s).classList.remove('hidden'); document.getElementById('dot' + s).classList.add('active'); window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validarStep(n) {
      if (n === 1) { let c = ['correoLogin', 'empresa', 'nombreSST', 'cedulaSST', 'areaEquipo', 'unidadNegocio', 'localidad']; for (let x of c) { if (!document.getElementById(x).value.trim()) { alert('Complete todos los campos obligatorios.'); document.getElementById(x).focus(); return false; } } let rows = document.getElementById('tbodyTrab').rows; if (!rows.length) { alert('Agregue al menos un trabajador.'); return false; } for (let r of rows) { if (!r.querySelector('.t-nombre').value.trim() || !r.querySelector('.t-cedula').value.trim()) { alert('Complete datos de trabajadores.'); return false; } } return true; }
      if (n === 2) { if (!document.getElementById('solic').value.trim() || !document.getElementById('dueno').value.trim()) { alert('Seleccione Solicitante y Dueño del Área.'); return false; } return true; }
      if (n === 3) { if (!document.getElementById('desc').value.trim() || !document.getElementById('tareasPrincipales').value.trim() || !document.getElementById('equiposHerramientas').value.trim()) { alert('Complete descripción, tareas y equipos.'); return false; } return true; }
      if (n === 4) { let cards = document.querySelectorAll('.riesgo-card'); for (let c of cards) { if (!c.querySelector('.r-peligro').value || !c.querySelector('.r-severidad').value || !c.querySelector('.r-probabilidad').value || !c.querySelector('.r-jerarquia').value || !c.querySelector('.r-controles').value.trim()) { alert('Complete todos los campos de riesgos.'); return false; } } return true; }
      return true;
    }

    function chkAR() { let v = document.getElementById('altoRiesgo').value === 'SI'; document.getElementById('divTipo').classList.toggle('hidden', !v); verificarGases(); }
    function verificarGases() { let t = Array.from(document.getElementById('tipoRiesgo').selectedOptions).map(o => o.value); document.getElementById('zonaGases').classList.toggle('hidden', !t.some(x => x.toLowerCase().includes('confinado'))); }
    document.addEventListener('change', function (e) { if (e.target.id === 'tipoRiesgo') verificarGases(); });

    function autoBuk(tipo) {
      let v = document.getElementById(tipo === 'solic' ? 'solic' : 'dueno').value;
      let f = buk.find(b => b.nombre === v);
      if (tipo === 'solic') {
        document.getElementById('procesoSolicitante').value = f ? f.proceso : '';
        document.getElementById('deptoSolicitante').value = f ? f.departamento : '';
      }
      else {
        document.getElementById('procesoDueno').value = f ? f.proceso : '';
        document.getElementById('deptoDueno').value = f ? f.departamento : '';
      }
    }

    function agregarTrabajador() {
      document.getElementById('tbodyTrab').insertAdjacentHTML('beforeend',
        '<tr><td><input type="text" class="form-control form-control-sm t-nombre" required></td><td><input type="text" class="form-control form-control-sm t-cedula" required></td><td><input type="text" class="form-control form-control-sm t-cargo"></td><td class="text-center"><input type="file" class="form-control form-control-sm t-firma-file" accept="image/png, image/jpeg" required></td><td class="text-center"><button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarFila(this)"><i class="bi bi-trash3"></i></button></td></tr>'
      );
    }
    function eliminarFila(b) { let tb = b.closest('tbody'); if (tb.rows.length > 1) b.closest('tr').remove(); else alert('Debe haber al menos un trabajador.'); }

    function vBtnFirma(inputCI) {
      let fila = inputCI.closest('tr');
      let btn = fila.querySelector('.btn-firmar-trab');
      let nombre = fila.querySelector('.t-nombre').value.trim();
      let ci = inputCI.value.trim();
      btn.disabled = !(nombre && ci);
    }

    function abrirModalFirma(btn) {
      filaTrabajadorActiva = btn.closest('tr');
      let nombre = filaTrabajadorActiva.querySelector('.t-nombre').value;
      let ci = filaTrabajadorActiva.querySelector('.t-cedula').value;

      document.getElementById('lblTrabNombre').innerText = nombre;
      document.getElementById('lblTrabCedula').innerText = ci;

      // Limpiar widget modal y configurarlo para este trabajador (busca por CI en vez de correo por ahora)
      limpiarFirma('TrabajadorModal');
      document.getElementById('chk-guardar-TrabajadorModal').checked = true;

      let myModal = new bootstrap.Modal(document.getElementById('modalFirmaTrabajador'));
      myModal.show();

      // Al mostrarse por primera vez The DOM debe pintar el canvas
      setTimeout(() => {
        inicializarFirmaWidget('TrabajadorModal', ci); // pasamos CI como identificador falso de correo
      }, 300);
    }

    function confirmarFirmaModal() {
      let res = obtenerResultadoFirmaWidget('TrabajadorModal');
      if (res.error) {
        alert(res.error);
        return;
      }

      // Guardar en la fila
      filaTrabajadorActiva.querySelector('.t-firma-base64').value = res.base64;
      let btn = filaTrabajadorActiva.querySelector('.btn-firmar-trab');
      btn.classList.remove('btn-outline-primary');
      btn.classList.add('btn-success');
      btn.innerHTML = '<i class="bi bi-check2-all"></i> Firmado';

      // Opcional: Solicitar a backend guardarFirmaBanco
      if (res.guardarEnBanco) {
        let ci = filaTrabajadorActiva.querySelector('.t-cedula').value;
        let nombre = filaTrabajadorActiva.querySelector('.t-nombre').value;
        google.script.run.guardarFirmaBanco(ci, nombre, res.base64);
      }

      bootstrap.Modal.getInstance(document.getElementById('modalFirmaTrabajador')).hide();
    }

    function previewFoto(i) { let p = document.getElementById('fotoPreview'); if (i.files && i.files[0]) { let r = new FileReader(); r.onload = e => { p.src = e.target.result; p.style.display = 'block'; }; r.readAsDataURL(i.files[0]); } else p.style.display = 'none'; }

    function agregarRiesgo() {
      contadorRiesgos++; let n = contadorRiesgos;
      let op = s => conf[s] ? conf[s].map(x => {
        let val = x.includes('(') ? x.split('(')[1].replace(')', '') : x;
        return '<option value="' + val + '">' + x + '</option>';
      }).join('') : '';

      document.getElementById('contenedorRiesgos').insertAdjacentHTML('beforeend', `
        <div class="riesgo-card" id="riesgo${n}">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span class="badge" style="background:var(--crimson)">Riesgo #${n}</span>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="eliminarRiesgo(${n})"><i class="bi bi-x-circle"></i></button>
          </div>
          <div class="row g-2">
            <div class="col-md-6">
              <label class="small fw-semibold">Identificación de Peligro *</label>
              <select class="form-select form-select-sm r-peligro" title="Peligro"><option value="">-- Seleccione --</option>${op('peligros')}</select>
            </div>
            <div class="col-md-6">
              <label class="small fw-semibold">Observación de Peligro *</label>
              <input type="text" class="form-control form-control-sm r-obs" placeholder="Ej. Presencia de CO2" required>
            </div>
            <div class="col-md-4">
              <label class="small fw-semibold">Severidad *</label>
              <select class="form-select form-select-sm r-severidad" onchange="calcRiesgos(this)" title="Severidad"><option value="">-- --</option>${op('severidad')}</select>
            </div>
            <div class="col-md-4">
              <label class="small fw-semibold">Probabilidad *</label>
              <select class="form-select form-select-sm r-probabilidad" onchange="calcRiesgos(this)" title="Probabilidad"><option value="">-- --</option>${op('probabilidad')}</select>
            </div>
            <div class="col-md-4">
              <label class="small fw-semibold">Riesgo Inherente</label>
              <input type="text" class="form-control form-control-sm r-inherente text-center fw-bold" readonly placeholder="Auto">
            </div>
            <div class="col-md-6">
              <label class="small fw-semibold">Jerarquía de Controles *</label>
              <select class="form-select form-select-sm r-jerarquia" onchange="calcRiesgos(this)" title="Jerarquía"><option value="">-- Seleccione --</option>${op('jerarquia')}</select>
            </div>
            <div class="col-md-6">
              <label class="small fw-semibold">Riesgo Residual</label>
              <input type="text" class="form-control form-control-sm r-residual text-center fw-bold" readonly placeholder="Auto">
            </div>
            <div class="col-12">
              <label class="small fw-semibold">Controles Aplicados *</label>
              <textarea class="form-control form-control-sm r-controles" rows="2" placeholder="Describa las medidas..."></textarea>
            </div>
          </div>
        </div>
      `);
    }
    function eliminarRiesgo(n) { let c = document.getElementById('contenedorRiesgos'); if (c.children.length > 1) document.getElementById('riesgo' + n).remove(); else alert('Mínimo un riesgo.'); }

    function calcRiesgos(el) {
      let card = el.closest('.riesgo-card');
      let s = parseInt(card.querySelector('.r-severidad').value) || 0;
      let p = parseInt(card.querySelector('.r-probabilidad').value) || 0;
      let j = parseInt(card.querySelector('.r-jerarquia').value) || 1;

      let ri = s * p;
      let rr = Math.ceil(ri / j);

      card.querySelector('.r-inherente').value = ri;
      card.querySelector('.r-residual').value = rr;

      // Colores visuales
      card.querySelector('.r-residual').style.backgroundColor = rr > 4 ? '#ffebee' : '#e8f5e9';
      card.querySelector('.r-residual').style.color = rr > 4 ? '#c62828' : '#2e7d32';
    }

    async function guardar() {
      // 1. Validar Firma Analista
      let resFirmaSST = obtenerResultadoFirmaWidget('AnalistaSST');
      if (resFirmaSST.error) { alert('SST: ' + resFirmaSST.error); nav(5); return; }

      // 2. Validar y Procesar Firmas Trabajadores
      let trabajadores = [];
      for (let f of document.getElementById('tbodyTrab').rows) {
        let nom = f.querySelector('.t-nombre').value.trim();
        let ced = f.querySelector('.t-cedula').value.trim();
        let file = f.querySelector('.t-firma-file');

        if (!file.files || !file.files[0]) {
          alert(`Falta la firma adjunta del trabajador ${nom} (${ced}).`);
          nav(1); return;
        }

        let base64 = await new Promise(res => {
          let r = new FileReader();
          r.onload = e => res(e.target.result);
          r.readAsDataURL(file.files[0]);
        });

        trabajadores.push({ nombre: nom, cedula: ced, cargo: f.querySelector('.t-cargo').value.trim(), firma: base64 });
      }

      let btn = document.getElementById('btnGuardar');
      btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...';
      btn.disabled = true;

      let riesgos = [];
      for (let c of document.querySelectorAll('.riesgo-card')) {
        riesgos.push({
          peligro: c.querySelector('.r-peligro').value,
          observacion: c.querySelector('.r-obs').value.trim(),
          severidad: c.querySelector('.r-severidad').value,
          probabilidad: c.querySelector('.r-probabilidad').value,
          jerarquia: c.querySelector('.r-jerarquia').value,
          controles: c.querySelector('.r-controles').value.trim()
        });
      }

      let fotoPromise = new Promise(resolve => {
        let fi = document.getElementById('fotoArea');
        if (fi.files && fi.files[0]) {
          let r = new FileReader();
          r.onload = e => resolve(e.target.result);
          r.readAsDataURL(fi.files[0]);
        } else resolve('');
      });

      fotoPromise.then(foto64 => {
        let d = {
          correoLogin: document.getElementById('correoLogin').value.trim(),
          empresa: document.getElementById('empresa').value.trim(),
          nombreSST: document.getElementById('nombreSST').value.trim(),
          cedulaSST: document.getElementById('cedulaSST').value.trim(),
          unidadNegocio: document.getElementById('unidadNegocio').value,
          localidad: document.getElementById('localidad').value,
          sede: document.getElementById('sede').value,
          areaEquipo: document.getElementById('areaEquipo').value.trim(),
          fotoAreaBase64: foto64,
          solicitanteInterno: document.getElementById('solic').value,
          deptoSolicitante: document.getElementById('deptoSolicitante').value,
          procesoSolicitante: document.getElementById('procesoSolicitante').value,
          duenoArea: document.getElementById('dueno').value,
          deptoDueno: document.getElementById('deptoDueno').value,
          procesoDueno: document.getElementById('procesoDueno').value,
          descripcion: document.getElementById('desc').value.trim(),
          tareasPrincipales: document.getElementById('tareasPrincipales').value.trim(),
          equiposHerramientas: document.getElementById('equiposHerramientas').value.trim(),
          altoRiesgo: document.getElementById('altoRiesgo').value,
          tipoRiesgo: Array.from(document.getElementById('tipoRiesgo').selectedOptions).map(o => o.value).join(', '),
          gases: {
            o2: document.getElementById('gasO2').value || '',
            lel: document.getElementById('gasLEL').value || '',
            co: document.getElementById('gasCO').value || '',
            h2s: document.getElementById('gasH2S').value || ''
          },
          firmaBase64: resFirmaSST.base64,
          trabajadores: trabajadores,
          riesgos: riesgos
        };

        google.script.run
          .withSuccessHandler(r => {
            if (r.success) {
              document.querySelectorAll('[id^="step"]').forEach(e => e.classList.add('hidden'));
              document.getElementById('stepResult').classList.remove('hidden');
              document.getElementById('stepResult').innerHTML = '<div class="success-screen"><div class="icon"><i class="bi bi-check-circle-fill"></i></div><h4>¡Permiso Registrado!</h4><p class="pt-id">' + r.idPT + '</p><p class="text-muted">' + (r.requiereMedico ? 'Enviado al Servicio Médico para validación.' : 'Enviado a los Validadores para aprobación.') + '</p><div class="info-bar mt-3"><small>Se ha notificado por correo a los responsables del siguiente paso.</small></div></div>';
            } else {
              alert('Error: ' + r.message);
              btn.innerHTML = '<i class="bi bi-send-check"></i> Solicitar Permiso PTD';
              btn.disabled = false;
            }
          })
          .withFailureHandler(e => {
            alert('Error: ' + e.message);
            btn.innerHTML = '<i class="bi bi-send-check"></i> Solicitar Permiso PTD';
            btn.disabled = false;
          })
          .guardarNuevoPT(d);
      });
    }
  </script>
</body>

</html>