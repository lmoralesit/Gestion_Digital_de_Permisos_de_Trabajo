<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"><title>Solicitud PTD</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <style>
    body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif;}
    .navbar-custom { background: linear-gradient(90deg, #003366 0%, #00509e 100%); box-shadow: 0 4px 6px rgba(0,0,0,0.1);}
    .card-wizard { border: none; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.08);}
    .step-header { color: #003366; font-weight: 700; border-bottom: 2px solid #e9ecef; padding-bottom: 12px; margin-bottom: 24px;}
    .hidden { display: none !important; }
    canvas.firma-box { width: 100%; height: 180px; border: 2px dashed #00509e; border-radius: 8px; background: #fafafa;}
  </style>
</head>
<body>
  <nav class="navbar navbar-dark navbar-custom mb-4"><div class="container"><span class="navbar-brand fw-bold">Sistema de Permisos de Trabajo (PTD)</span></div></nav>
  <div class="container mb-5"><div class="card card-wizard p-4 mx-auto" style="max-width: 900px;">
      
      <div id="loader" class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-3 text-muted">Sincronizando sistemas...</p></div>

      <form id="formPTD" class="hidden">
        <datalist id="listEmpresas"></datalist><datalist id="listBuk"></datalist>

        <div id="step1">
          <h5 class="step-header">Módulo 1: Ubicación y Ejecutantes</h5>
          <div class="row g-3">
            <div class="col-md-6"><label>Tu Correo Google</label><input type="email" id="correoLogin" class="form-control" required></div>
            <div class="col-md-6"><label>Empresa Contratista</label><input type="text" id="empresa" list="listEmpresas" class="form-control"></div>
            <div class="col-md-4"><label>Analista SST</label><input type="text" id="nombreSST" class="form-control"></div>
            <div class="col-md-4"><label>Cédula SST</label><input type="number" id="cedulaSST" class="form-control"></div>
            <div class="col-md-4"><label>Área/Equipo</label><input type="text" id="areaEquipo" class="form-control"></div>
            <div class="col-md-4"><label>Unidad Negocio</label><select id="unidadNegocio" class="form-select"></select></div>
            <div class="col-md-4"><label>Localidad</label><select id="localidad" class="form-select" onchange="filtroSedes()"></select></div>
            <div class="col-md-4"><label>Sede</label><select id="sede" class="form-select"></select></div>
          </div>
          <div class="mt-4 text-end"><button type="button" class="btn btn-primary px-4" onclick="nav(2)">Continuar</button></div>
        </div>

        <div id="step2" class="hidden">
          <h5 class="step-header">Módulo 2: Validadores Internos</h5>
          <div class="row g-3">
            <div class="col-12"><label class="fw-bold">Solicitante Interno (Buscar)</label><input type="text" id="solic" list="listBuk" class="form-control border-primary" onchange="autoBuk('solic')"></div>
            <div class="col-12 mt-4"><label class="fw-bold">Dueño del Área (Buscar)</label><input type="text" id="dueno" list="listBuk" class="form-control border-primary" onchange="autoBuk('dueno')"></div>
          </div>
          <div class="d-flex justify-content-between mt-5"><button type="button" class="btn btn-outline-secondary" onclick="nav(1)">Atrás</button><button type="button" class="btn btn-primary px-4" onclick="nav(3)">Continuar</button></div>
        </div>

        <div id="step3" class="hidden">
          <h5 class="step-header">Módulo 3: Actividad y Riesgos</h5>
          <div class="row g-3">
            <div class="col-12"><label>Descripción del Trabajo</label><textarea id="desc" class="form-control" rows="2"></textarea></div>
            <div class="col-6"><label class="text-danger fw-bold">¿Alto Riesgo?</label><select id="altoRiesgo" class="form-select border-danger" onchange="chkAR()"><option value="NO">NO</option><option value="SI">SI</option></select></div>
            <div class="col-6 hidden" id="divTipo"><label>Tipo (Ctrl+Clic múltiples)</label><select id="tipoRiesgo" class="form-select" multiple size="3"></select></div>
          </div>
          <div class="d-flex justify-content-between mt-5"><button type="button" class="btn btn-outline-secondary" onclick="nav(2)">Atrás</button><button type="button" class="btn btn-primary px-4" onclick="nav(4)">Firma Final</button></div>
        </div>

        <div id="step4" class="hidden">
          <h5 class="step-header">Firma del Analista Solicitante</h5>
          <canvas id="pad" class="firma-box"></canvas>
          <div class="d-grid mt-4"><button type="button" class="btn btn-success btn-lg" onclick="guardar()">Solicitar Permiso PTD</button></div>
        </div>
      </form>
  </div></div>
  <script>
    let conf={}, buk=[], sp;
    window.onload = () => {
      sp = new SignaturePad(document.getElementById('pad'));
      google.script.run.withSuccessHandler(r=>{conf=r; iniL();}).obtenerListasConfig();
      google.script.run.withSuccessHandler(r=>{buk=r; iniB();}).obtenerColaboradoresBuk();
    };
    function iniL() { document.getElementById('listEmpresas').innerHTML = conf.empresas.map(e=>`<option value="${e}">`).join(''); conf.unidades.forEach(u=>document.getElementById('unidadNegocio').innerHTML+=`<option>${u}</option>`); conf.localidades.forEach(l=>document.getElementById('localidad').innerHTML+=`<option>${l}</option>`); conf.tiposTrabajo.forEach(t=>document.getElementById('tipoRiesgo').innerHTML+=`<option value="${t}">${t}</option>`); document.getElementById('loader').classList.add('hidden'); document.getElementById('formPTD').classList.remove('hidden'); }
    function iniB() { document.getElementById('listBuk').innerHTML = buk.map(b=>`<option value="${b.nombre} (${b.email})">`).join(''); }
    function filtroSedes() { let l=document.getElementById('localidad').value; let s=document.getElementById('sede'); s.innerHTML=''; conf.sedesMap.forEach(m=>{let p=m.split('|'); if(p[0]===l) s.innerHTML+=`<option>${p[1]}</option>`;}); }
    function nav(s) { document.querySelectorAll('[id^="step"]').forEach(e=>e.classList.add('hidden')); document.getElementById('step'+s).classList.remove('hidden'); }
    function chkAR() { document.getElementById('divTipo').classList.toggle('hidden', document.getElementById('altoRiesgo').value==='NO'); }
    function guardar() {
      if(sp.isEmpty()) return alert("Firme el documento.");
      document.querySelector('.btn-success').innerText="Guardando...";
      let d = { correoLogin: document.getElementById('correoLogin').value, empresa: document.getElementById('empresa').value, nombreSST: document.getElementById('nombreSST').value, cedulaSST: document.getElementById('cedulaSST').value, unidadNegocio: document.getElementById('unidadNegocio').value, localidad: document.getElementById('localidad').value, sede: document.getElementById('sede').value, areaEquipo: document.getElementById('areaEquipo').value, solicitanteInterno: document.getElementById('solic').value, deptoSolicitante:'', procesoSolicitante:'', duenoArea: document.getElementById('dueno').value, deptoDueno:'', procesoDueno:'', descripcion: document.getElementById('desc').value, altoRiesgo: document.getElementById('altoRiesgo').value, tipoRiesgo: Array.from(document.getElementById('tipoRiesgo').selectedOptions).map(o=>o.value).join(','), gases:{o2:'', lel:'', co:'', h2s:''}, firmaBase64: sp.toDataURL(), trabajadores:[], riesgos:[] };
      google.script.run.withSuccessHandler(r=>{ document.getElementById('step4').innerHTML=`<div class='alert alert-success'>Permiso Registrado: <b>${r.idPT}</b></div>`; }).guardarNuevoPT(d);
    }
  </script>
</body></html>